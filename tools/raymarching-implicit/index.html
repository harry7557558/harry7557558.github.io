<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Implicit Surface Rendering Demo</title>
    <meta name="description" content="Explore raymarching-based implicit surface rendering in WebGL2." />
    <meta name="keywords" content="harry7557558, raymarching, raycasting, isosurface, implicit, surface, 3d" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="style.css" />
    <script src="parser.js"></script>
    <script src="render.js"></script>

</head>

<body>
    <canvas id="canvas"></canvas>

    <div id="fps"></div>

    <div id="control">
        <select id="builtin-functions"></select>
        <br />
        <textarea id="equation-input" style="width:100%;height:8em;resize:vertical" spellcheck="false"
            autocapitalize="off" autocorrect="off"></textarea>
        <br />
        <span title="Use y-up coordinate system convension"><input type="checkbox"
                id="checkbox-yup" /><i>y</i>-up</span>&ensp;
        <span><select id="select-step">
                <option value="0.04">low</option>
                <option value="0.01" selected>medium</option>
                <option value="0.004">high</option>
                <option value="0.001">ultra high</option>
            </select>&nbsp;quality</span>
        <br />
        <span title="Color surface based on normal"><input type="checkbox" id="checkbox-color"
                checked />color</span>&ensp;
        <span title="Display the surface as semi-transparent"><input type="checkbox"
                id="checkbox-transparency" />transparency</span>
        <br />
        <span title="Analytical gradient usually makes rendering faster and compilation slower"><input type="checkbox"
                id="checkbox-analygrad" checked />analytical&nbsp;grad</span>&ensp;
        <span title="Red-highlight discontinuities with sign change for opaque surfaces"><input type="checkbox"
                id="checkbox-discontinuity" />discontinuity</span>
        <br />
        <span><i>θ<sub>light</sub></i>&nbsp;<input type="range" id="slider-theta" min="-90" max="270" value="30"
                style="width:100px" /></span>
        <span><i>φ<sub>light</sub></i>&nbsp;<input type="range" id="slider-phi" min="0" max="180" value="30"
                style="width:60px" /></span>
        <br />
        <p id="error-message" style="color:red;white-space:normal;margin-bottom:0"></p>
    </div>

    <script>
        function setCookie(value) {
            if (!navigator.cookieEnabled) return false;
            var date = new Date();
            date.setTime(date.getTime() + (365 * 86400000));
            var expires = " expires=" + date.toUTCString();
            var base64 = window.btoa(value);
            document.cookie = "raymarchImplicitInput=" + base64 + ";" + expires;
        }
        function getCookie() {
            const name = "raymarchImplicitInput=";
            var ca = document.cookie.split(';');
            for (var i = 0; i < ca.length; i++) {
                var c = ca[i].trim();
                if (c.indexOf(name) == 0) {
                    var base64 = c.substring(name.length, c.length);
                    return window.atob(base64);
                }
            }
            return "";
        }

        window.addEventListener("load", async function (event) {
            var glsl = {};
            let checkboxColor = document.querySelector("#checkbox-color");
            let checkboxTransparency = document.querySelector("#checkbox-transparency");
            let checkboxYup = document.querySelector("#checkbox-yup");
            let checkboxAnalyGrad = document.querySelector("#checkbox-analygrad");
            let checkboxDiscontinuity = document.querySelector("#checkbox-discontinuity");
            let selectStep = document.querySelector("#select-step");

            // init built-in functions
            let select = document.querySelector("#builtin-functions");
            let input = document.querySelector("#equation-input");
            select.innerHTML += "<option value=''>Load preset...</option>";
            for (var i = 0; i < builtinFunctions.length; i++) {
                let fun = builtinFunctions[i];
                select.innerHTML += "<option value=" + fun[1] + ">" + fun[0] + "</option>"
            }
            let initialExpr = getCookie();
            if (initialExpr != "") {
                select.childNodes[0].setAttribute("value", initialExpr);
                select.childNodes[0].selected = true;
            }
            else select.childNodes[1].selected = true;

            // called when update selected function
            function updateFunctionInput() {
                let errorMessage = document.querySelector("#error-message");
                var expr = input.value;
                setCookie(expr);
                try {
                    var postfix = inputToPostfix(expr);
                    glsl = postfixToGlsl(postfix);
                    console.log(glsl.glsl);
                    console.log(glsl.glslgrad);
                    updateShaderFunction(glsl.glsl, glsl.glslgrad,
                        selectStep.value,
                        checkboxColor.checked, checkboxTransparency.checked,
                        checkboxYup.checked, checkboxAnalyGrad.checked,
                        checkboxDiscontinuity.checked);
                    errorMessage.style.display = "none";
                } catch (e) {
                    console.error(e);
                    errorMessage.style.display = "inline-block";
                    errorMessage.innerHTML = e;
                }
            }

            checkboxColor.addEventListener("input", updateFunctionInput);
            checkboxTransparency.addEventListener("input", updateFunctionInput);
            checkboxYup.addEventListener("input", updateFunctionInput);
            checkboxAnalyGrad.addEventListener("input", updateFunctionInput);
            checkboxDiscontinuity.addEventListener("input", updateFunctionInput);
            selectStep.addEventListener("input", updateFunctionInput);
            select.addEventListener("input", function (event) {
                input.value = select.value.replaceAll(";", "\n");
                updateFunctionInput();
            });
            input.addEventListener("input", function (event) {
                select.value = initialExpr;
                updateFunctionInput();
            });
            input.value = select.value.replaceAll(";", "\n");

            // main
            initWebGL();
            updateFunctionInput();
            try {
                initRenderer();
            } catch (e) {
                console.error(e);
                document.body.innerHTML = "<h1 style='color:red;'>" + e + "</h1>";
            }
        });
    </script>

</body>

</html>